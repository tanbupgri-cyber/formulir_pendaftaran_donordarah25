<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendaftaran Donor Darah - HGN & HUT PGRI Ke-80 Tanah Bumbu</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Header Customization */
        .custom-header {
            width: 100%;
            max-width: 1600px;
            aspect-ratio: 4/1;
            background-image: url('https://photos.app.goo.gl/B9M46MKp2XR1X2a97'); /* Ganti URL ini nanti */
            background-size: cover;
            background-position: center;
            margin: 0 auto;
            border-bottom: 5px solid #d9534f; /* Merah Darah */
        }

        .navbar { background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-link { color: #333; font-weight: 600; }
        .nav-link.active { color: #d9534f !important; border-bottom: 2px solid #d9534f; }
        
        .section-content { display: none; padding: 20px 0; }
        .section-content.active { display: block; }
        
        .card-dashboard { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header-custom { background-color: #d9534f; color: white; border-radius: 10px 10px 0 0 !important; }
        
        /* Button Styles */
        .btn-pgri { background-color: #d9534f; color: white; }
        .btn-pgri:hover { background-color: #c9302c; color: white; }
    </style>
</head>
<body>

    <div class="container-fluid p-0">
       <img src= "image/gambar halaman.jpg" class="w-100" alt="Header Spanduk PGRI" style="height: auto; display: block;">
    </div>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-heartbeat text-danger"></i> DONOR DARAH PGRI PGRI TANAH BUMBU
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="switchMenu('beranda', this)">Beranda</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchMenu('formulir', this)">Isi_Formulir_Pendaftaran</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="switchMenu('download', this)">Download_Rekap_Data</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container my-4">

        <div id="beranda" class="section-content active">
            <h3 class="mb-4 border-start border-5 border-danger ps-3">Dashboard Monitoring Peserta</h3>
            
            <div class="row text-center mb-4">
                <div class="col-md-12">
                    <div class="card card-dashboard bg-white p-4">
                        <h1 class="display-4 fw-bold text-danger" id="totalPeserta">0</h1>
                        <p class="text-muted text-uppercase ls-1">Total Peserta Terdaftar</p>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-4">
                    <div class="card card-dashboard">
                        <div class="card-header card-header-custom">Peserta per Cabang PGRI</div>
                        <div class="card-body">
                            <canvas id="chartCabang"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-dashboard">
                        <div class="card-header card-header-custom">Golongan Darah</div>
                        <div class="card-body">
                            <canvas id="chartDarah"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card card-dashboard">
                        <div class="card-header card-header-custom">Unit Kerja (Simulasi)</div>
                        <div class="card-body">
                            <canvas id="chartUnit"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="formulir" class="section-content">
            <h3 class="mb-4 border-start border-5 border-danger ps-3">formulir pendaftaran donor darah</h3>
            <div class="alert alert-warning">
                ‚ö†Ô∏è **Penting:** Pastikan Anda telah membuat tabel **`formulir pendaftaran donor darah`** 
            </div>
            <div class="card card-dashboard">
                <div class="card-body p-4">
                    <form id="formDonor">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Nama Lengkap</label>
                                <input type="text" class="form-control" id="nama" required placeholder="Nama lengkap beserta gelar">
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Unit Kerja</label>
                                <input type="text" class="form-control" id="unitKerja" required placeholder="Contoh: SDN 1 Batulicin">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Tempat, Tanggal Lahir</label>
                                <input type="text" class="form-control" id="ttl" required placeholder="Contoh: Tanah Bumbu, 12-12-1985">
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Golongan Darah</label>
                                <select class="form-select" id="golDarah" required>
                                    <option value="">Pilih...</option>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="AB">AB</option>
                                    <option value="O">O</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Utusan Cabang PGRI</label>
                                <select class="form-select" id="cabangPgri" required>
                                    <option value="">Pilih Kecamatan...</option>
                                    <option value="Batulicin">Batulicin</option>
                                    <option value="Simpang Empat">Simpang Empat</option>
                                    <option value="Kusan Hilir">Kusan Hilir</option>
                                    <option value="Satui">Satui</option>
                                    <option value="Sungai Loban">Sungai Loban</option>
                                    <option value="Kusan Hulu">Kusan Hulu</option>
                                    <option value="Kusan tengah">Kusan Tengah</option>
                                    <option value="Mantewe">Mantewe</option>
                                    <option value="Kuranji">Kuranji</option>
                                    <option value="Karang Bintang">Karang Bintang</option>
                                    <option value="Angsana">Angsana</option>
                                    <option value="Teluk Kepayang">Teluk Kepayang</option>
                                </select>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Nomor HP / WA</label>
                                <input type="number" class="form-control" id="noHp" required>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Pernah Mendonor?</label>
                                <select class="form-select" id="historyDonor" onchange="toggleLastDate()" required>
                                    <option value="TIDAK">Tidak</option>
                                    <option value="YA">Ya</option>
                                </select>
                            </div>

                            <div class="col-md-6" id="divLastDate" style="display: none;">
                                <label class="form-label text-danger fw-bold">Kapan Terakhir Donor Darah?</label>
                                <input type="date" class="form-control" id="lastDonorDate">
                            </div>

                            <div class="col-12">
                                <label class="form-label">Unggah Foto Peserta</label>
                                <input type="file" class="form-control" id="fotoPeserta" accept="image/*" required>
                                <small class="text-muted">Format: JPG/PNG. Maksimal 2MB. (Foto akan digunakan di PDF)</small>
                            </div>

                            <div class="col-12 mt-4">
                                <button type="submit" class="btn btn-pgri btn-lg w-100"><i class="fas fa-paper-plane"></i> Daftar & Download Bukti PDF</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div id="download" class="section-content">
            <h3 class="mb-4 border-start border-5 border-danger ps-3">Rekap Data Peserta</h3>
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> Data di bawah ini dimuat langsung dari Supabase Anda.
            </div>
            
            <div class="card card-dashboard">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tabelRekap">
                            <thead class="table-dark">
                                <tr>
                                    <th>No</th>
                                    <th>Nama</th>
                                    <th>Unit Kerja</th>
                                    <th>Gol. Darah</th>
                                    <th>Cabang</th>
                                    <th>No HP</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyRekap">
                            </tbody>
                        </table>
                    </div>
                    <button onclick="downloadRekapPDF()" class="btn btn-success mt-3"><i class="fas fa-file-pdf"></i> Download Rekap PDF (Landscape)</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // ===============================================
        // *** LANGKAH 1: KONFIGURASI SUPABASE ANDA ***
        // GANTI nilai di bawah ini dengan URL dan KUNCI API Anon Anda dari proyek Supabase.
        // ===============================================
        const SUPABASE_URL = 'https://yuaqnktrpzyyszoewdbl.supabase.co'; // üëà GANTI INI!
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1YXFua3RycHp5eXN6b2V3ZGJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NTUzMTYsImV4cCI6MjA3OTEzMTMxNn0.chjhe4b8yacLSLLJ8v9fnXTjcMHU0mFP1VZFaP5CPcQ'; // üëà GANTI INI!
        const TABLE_NAME = 'formulir pendaftaran donor darah'; // Pastikan ini sesuai dengan nama tabel Anda di Supabase

        // Inisialisasi Klien Supabase
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        // ===============================================


        // === LOGIKA NAVIGASI & FORM ===
        function switchMenu(menuId, element) {
            document.querySelectorAll('.section-content').forEach(el => el.classList.remove('active'));
            document.getElementById(menuId).classList.add('active');
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
            element.classList.add('active');

            if (menuId === 'beranda' || menuId === 'download') {
                loadDataPeserta();
            }
        }

        function toggleLastDate() {
            const status = document.getElementById('historyDonor').value;
            const div = document.getElementById('divLastDate');
            if (status === 'YA') {
                div.style.display = 'block';
                document.getElementById('lastDonorDate').setAttribute('required', 'required');
            } else {
                div.style.display = 'none';
                document.getElementById('lastDonorDate').removeAttribute('required');
            }
        }


        // ===============================================
        // *** LOGIKA SUPABASE: MUAT DATA & REKAP ***
        // ===============================================
        let dataPesertaGlobal = []; // Akan menyimpan data yang dimuat dari Supabase

        async function loadDataPeserta() {
            const { data, error } = await supabaseClient
                .from(formulir pendaftaran donor darah)
                .select('*'); // <--- CUKUP SAMPAI DI SINI
        // ...

            // Baris 288 di index.html (Kode Baru)
if (error) {
    console.error("Gagal memuat data dari Supabase:", error.message);
    
    // HAPUS DATA DUMMY: Set data global menjadi array kosong
    dataPesertaGlobal = []; // üëà PERUBAHAN UTAMA DI SINI

    alert("Gagal koneksi ke Supabase. Dashboard dan Tabel Rekap dikosongkan. Harap cek error di console!");
    
    // PENTING: Kita tetap memanggil updateDashboard/updateTabelRekap agar layar ter-refresh dengan data kosong
    updateDashboard(dataPesertaGlobal);
    updateTabelRekap(dataPesertaGlobal);
    return; // Keluar dari fungsi jika terjadi error
} else {
    dataPesertaGlobal = data;
}

// ... kode setelahnya (updateDashboard, updateTabelRekap)
            
            updateDashboard(dataPesertaGlobal);
            updateTabelRekap(dataPesertaGlobal);
        }


        // === UPDATE DASHBOARD DAN REKAP ===
        function updateDashboard(data) {
            document.getElementById('totalPeserta').innerText = data.length;
            
            const hitungGolongan = data.reduce((acc, p) => {
                acc[p.golongan_darah] = (acc[p.golongan_darah] || 0) + 1;
                return acc;
            }, {});

            const hitungCabang = data.reduce((acc, p) => {
                acc[p.cabang_pgri] = (acc[p.cabang_pgri] || 0) + 1;
                return acc;
            }, {});

            renderCharts(hitungCabang, hitungGolongan);
        }

        function updateTabelRekap(data) {
            const tbody = document.getElementById('tbodyRekap');
            tbody.innerHTML = "";
            data.forEach((p, index) => {
                tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${p.nama_lengkap}</td>
                        <td>${p.unit_kerja}</td>
                        <td>${p.golongan_darah}</td>
                        <td>${p.cabang_pgri}</td>
                        <td>${p.nomor_hp}</td>
                    </tr>
                `;
            });
        }

        // === RENDER GRAFIK (CHART.JS) ===
        let chartCabangInstance, chartDarahInstance, chartUnitInstance;
        
        function renderCharts(dataCabang, dataDarah) {
            // Hapus instance lama jika ada
            if (chartCabangInstance) chartCabangInstance.destroy();
            if (chartDarahInstance) chartDarahInstance.destroy();
            if (chartUnitInstance) chartUnitInstance.destroy();

            // Chart Unit Kerja (DUMMY/SIMULASI)
            const ctxUnit = document.getElementById('chartUnit').getContext('2d');
            chartUnitInstance = new Chart(ctxUnit, { 
                type: 'doughnut',
                data: {
                    labels: ['SD', 'SMP', 'SMA', 'Dinas/Lainnya'],
                    datasets: [{ 
                        data: [15, 10, 5, 2], // Dummy Data
                        backgroundColor: ['#FF9F40', '#9966FF', '#FF6384', '#4BC0C0'] 
                    }]
                }
            });


            // Chart Cabang PGRI
            const labelsCabang = Object.keys(dataCabang);
            const dataValuesCabang = Object.values(dataCabang);

            const ctxCabang = document.getElementById('chartCabang').getContext('2d');
            chartCabangInstance = new Chart(ctxCabang, {
                type: 'pie',
                data: {
                    labels: labelsCabang,
                    datasets: [{ 
                        data: dataValuesCabang, 
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#8D36A2', '#A2368D', '#44A236', '#A27E36', '#36A29A', '#365BA2', '#A24F36', '#40FF9F'] 
                    }]
                }
            });

            // Chart Golongan Darah
            const labelsDarah = Object.keys(dataDarah);
            const dataValuesDarah = Object.values(dataDarah);
            
            const ctxDarah = document.getElementById('chartDarah').getContext('2d');
            chartDarahInstance = new Chart(ctxDarah, {
                type: 'bar',
                data: {
                    labels: labelsDarah,
                    datasets: [{ label: 'Jml Peserta', data: dataValuesDarah, backgroundColor: '#d9534f' }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }


        // ===============================================
        // *** LOGIKA SUPABASE: SUBMIT FORMULIR ***
        // ===============================================
        document.getElementById('formDonor').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Ambil Nilai dari Form
            const nama = document.getElementById('nama').value;
            const unit = document.getElementById('unitKerja').value;
            const ttl = document.getElementById('ttl').value;
            const gol = document.getElementById('golDarah').value;
            const cabang = document.getElementById('cabangPgri').value;
            const hp = document.getElementById('noHp').value;
            const history = document.getElementById('historyDonor').value;
            const lastDonor = (history === 'YA') ? document.getElementById('lastDonorDate').value : null; 

            // Ambil File Foto (Hanya untuk PDF, TIDAK diunggah ke Supabase Storage dalam kode ini)
            const fotoFile = document.getElementById('fotoPeserta').files[0];

            if (!fotoFile) {
                alert("Harap unggah foto peserta (Wajib) sebelum mendaftar.");
                return;
            }

            // 1. SIAPKAN DATA UNTUK SUPABASE
            const insertData = {
                nama_lengkap: nama,
                unit_kerja: unit,
                tempat_tanggal_lahir: ttl,
                golongan_darah: gol,
                cabang_pgri: cabang,
                nomor_hp: hp,
                pernah_donor: history,
               tanggal_terakhir_donor: lastDonor,
            };
            
            // 2. INSERT KE SUPABASE
            const { error: insertError } = await supabaseClient
                .from(TABLE_NAME)
                .insert([insertData]);

            if (insertError) {
                alert("‚ùå Gagal menyimpan data ke Supabase! Harap cek konfigurasi dan koneksi Anda.");
                console.error("Supabase Insert Error:", insertError);
                return;
            }

            // 3. PROSES FOTO & GENERATE PDF
            const reader = new FileReader();
            reader.onload = function(event) {
                const fotoBase64 = event.target.result;
                
                // --- GENERATE PDF BUKTI PENDAFTARAN ---
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Placeholder Logo PGRI (Ganti dengan Base64 logo asli Anda jika diperlukan)
                const LOGO_PGRI_BASE64 = 'https://drive.google.com/file/d/1fHZyrUA-ZdAW7MVT2uphdS6SB7z59UFk/view?usp=sharing'; 
                
                doc.addImage(LOGO_PGRI_BASE64, 'PNG', 10, 10, 20, 20); 

                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.text("BUKTI PENDAFTARAN DONOR DARAH PGRI", 35, 15);
                doc.setFontSize(12);
                doc.setFont("helvetica", "normal");
                doc.text("HGN & HUT PGRI Ke-80, Kabupaten Tanah Bumbu", 35, 22);
                
                doc.setLineWidth(0.5);
                doc.line(10, 27, 200, 27); 

                let yPos = 40; 
                doc.setFontSize(11);
                doc.setFont("helvetica", "bold");
                doc.text("Data Peserta:", 20, yPos); yPos += 8;

                doc.setFont("helvetica", "normal");
                doc.text(`Nama Lengkap : ${nama}`, 20, yPos); yPos += 6;
                doc.text(`Unit Kerja : ${unit}`, 20, yPos); yPos += 6;
                doc.text(`TTL : ${ttl}`, 20, yPos); yPos += 6;
                doc.text(`Golongan Darah : ${gol}`, 20, yPos); yPos += 6;
                doc.text(`Pernah Donor : ${history}`, 20, yPos); yPos += 6;
                if (history === 'YA' && lastDonor) {
                    doc.text(`Terakhir Donor : ${lastDonor}`, 20, yPos); yPos += 6;
                }
                doc.text(`Cabang PGRI : ${cabang}`, 20, yPos); yPos += 6;
                doc.text(`Nomor HP : ${hp}`, 20, yPos); yPos += 15;

                doc.setFontSize(14);
                doc.setFont("helvetica", "bold");
                doc.setTextColor(217, 83, 79); 
                doc.text(`Status Pendaftaran: BERHASIL`, 20, yPos); yPos += 10;
                doc.setTextColor(0); 

                // Tambahkan Foto
                const imgWidth = 40;
                // Anda mungkin perlu menyesuaikan dimensi foto agar pas di PDF
                doc.addImage(fotoBase64, fotoFile.type.split('/')[1].toUpperCase(), 150, 35, imgWidth, imgWidth); 

                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text("*Harap membawa bukti ini (digital/cetak) saat pelaksanaan.", 20, yPos + 10);
                
                doc.save(`Bukti_Donor_${nama.replace(/\s/g, '_')}.pdf`);
                alert("‚úÖ Pendaftaran Berhasil dan data sudah tersimpan di Supabase! Bukti PDF telah diunduh.");
                document.getElementById('formDonor').reset();
                loadDataPeserta(); 
                switchMenu('beranda', document.querySelector('.nav-link[onclick="switchMenu(\'beranda\', this)"]')); // Pindah ke dashboard setelah daftar
            };

            reader.readAsDataURL(fotoFile);
        });

        // === DOWNLOAD REKAP PDF (Panitia) ===
        function downloadRekapPDF() {
            if (dataPesertaGlobal.length === 0 || dataPesertaGlobal[0].nama_lengkap === "Gagal Koneksi") {
                alert("Tidak ada data peserta atau gagal koneksi ke database untuk diunduh.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'mm', 'a4'); // 'l' for Landscape
            
            const tableColumn = ["No", "Nama Lengkap", "Unit Kerja", "Gol. Darah", "Cabang PGRI", "No HP", "Pernah Donor"];
            const tableRows = [];

            dataPesertaGlobal.forEach((p, index) => {
                const pesertaData = [
                    index + 1,
                    p.nama_lengkap,
                    p.unit_kerja,
                    p.golongan_darah,
                    p.cabang_pgri,
                    p.nomor_hp,
                    p.pernah_donor + (p.tanggal_terakhir_donor ? ` (${p.tanggal_terakhir_donor})` : '')
                ];
                tableRows.push(pesertaData);
            });

            doc.setFontSize(16);
            doc.text("REKAPITULASI PESERTA DONOR DARAH PGRI", 140, 15, null, null, 'center');
            doc.setFontSize(10);
            doc.text("Tanggal Unduh: " + new Date().toLocaleDateString('id-ID'), 140, 22, null, null, 'center');

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 30,
                headStyles: { fillColor: [217, 83, 79] }, 
                styles: { fontSize: 8 },
                margin: { top: 30, left: 10, right: 10, bottom: 10 }
            });

            doc.save(`Rekap_Donor_Darah_PGRI_${new Date().getTime()}.pdf`);
        }

        // === MUAT DATA PERTAMA KALI ===
        window.onload = function() {
            loadDataPeserta(); 
            toggleLastDate(); 
        };

        // Memastikan fungsi-fungsi dapat diakses dari HTML
        window.downloadRekapPDF = downloadRekapPDF;
        window.switchMenu = switchMenu; 
        window.toggleLastDate = toggleLastDate; 
    </script>

</body>
</html>














